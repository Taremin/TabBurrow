# バックグラウンド機能詳細

## 自動クローズ (`autoClose.ts`)

定期的に非アクティブなタブをスキャンし、条件に応じてタブを整理・保存する機能。

### 処理フロー
1.  **アラーム発火**: `chrome.alarms` により設定された間隔（`autoCloseSeconds` の半分、最大30秒ごと）で実行。
2.  **タブ取得**: `pinned: false` かつ `active: false` のタブのみ対象。
3.  **初期フィルタ**: `https://`, `http://`, `file://` 以外のスキーム（`chrome://` など）は無視。
4.  **時間チェック**: `tabLastActiveTime` (Map) を使用して、最後の操作から設定秒数以上経過しているか確認。
5.  **ルールマッチング**:
    *   ユーザー定義のルール (`settings.autoCloseRules`) を上から（または設定順で）評価。
    *   **Action**:
        *   `exclude`: 何もしない（自動クローズ対象外）。
        *   `saveToGroup`: 指定されたカスタムグループに保存して閉じる。
        *   `saveOnly`: 保存するがタブは閉じない（バックアップ用途）。
        *   `close`: 保存せずに閉じる（ゴミ掃除）。
        *   `pin`: タブをピン留めして保護。
6.  **デフォルト動作**: ルールにマッチしなかった場合、通常の「保存して閉じる」処理を実行。

## タブ保存 (`tabSaver.ts`)

*   **スクリーンショット**:
    *   アクティブタブの場合: `chrome.tabs.captureVisibleTab` で取得し、512x512にリサイズ。
    *   非アクティブタブの場合: `screenshotCache.ts` のキャッシュを確認。なければ空画像を使用（非アクティブタブのスクショはAPI制限で直接撮れないため）。
*   **重複チェック**: URLが既に保存されている場合、既存のレコードを更新（ID維持、最新のスクショで上書き）。

## コンテキストメニュー (`contextMenu.ts`)

*   **Exclude domain**: 現在のドメインを自動クローズ除外リストに追加するショートカット。
*   **Custom Groups**: カスタムグループへの追加・削除を行う動的メニュー。インストール時やグループ変更時に `updateCustomGroupMenus()` で再構築される。
