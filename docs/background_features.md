# バックグラウンド機能詳細

## 自動クローズ (`autoClose.ts`)

定期的に非アクティブなタブをスキャンし、条件に応じてタブを整理・保存する機能。

### 処理フロー
1.  **アラーム発火**: `browser.alarms` により設定された間隔（`autoCloseSeconds` の半分、最大30秒ごと）で実行。
2.  **タブ取得**: `pinned: false` かつ `active: false` のタブのみ対象。
3.  **初期フィルタ**: `https://`, `http://`, `file://` 以外のスキーム（`chrome://`、`about:` など）は無視。
4.  **時間チェック**: `tabLastActiveTime` (Map) を使用して、最後の操作から設定秒数以上経過しているか確認。
5.  **ルールマッチング**:
    *   ユーザー定義のルール (`settings.autoCloseRules`) を評価順序設定に従って評価。
    *   **Action**:
        *   `exclude`: 何もしない（自動クローズ対象外）。
        *   `saveToGroup`: 指定されたカスタムグループに保存して閉じる。
        *   `saveOnly`: 保存するがタブは閉じない（バックアップ用途）。
        *   `close`: 保存せずに閉じる（ゴミ掃除）。
        *   `pin`: タブをピン留めして保護。
6.  **デフォルト動作**: ルールにマッチしなかった場合、通常の「保存して閉じる」処理を実行。

## タブ保存 (`tabSaver.ts`)

*   **スクリーンショット**:
    *   `screenshot.ts` 経由で `browser.tabs.captureVisibleTab` を使用、512x512にリサイズ。
    *   非アクティブタブの場合: スクリーンショットキャッシュを確認。なければ空画像を使用。
*   **重複チェック**: URLが既に保存されている場合、既存のレコードを更新（ID維持、最新のスクショで上書き）。

## スクリーンショット (`screenshot.ts`)

*   **キャプチャ**: `browser.tabs.captureVisibleTab` でアクティブタブをキャプチャ。
*   **リサイズ**: Canvas APIで512x512 JPEGにリサイズ（品質80%）。
*   **検証**: キャプチャ時にタブIDを検証し、誤ったタブのスクリーンショットを防止。

## タブイベント監視 (`tabEvents.ts`)

タブのアクティベートや更新を監視し、スクリーンショットをキャッシュする機能。

*   **`browser.tabs.onActivated`**: タブがアクティブになった時にスクリーンショットをキャプチャしてキャッシュ。
*   **`browser.tabs.onUpdated`**: ページ読み込み完了時にスクリーンショットを更新。
*   **レースコンディション対策**: キャプチャ前後でタブIDを検証し、高速なタブ切り替え時の誤キャプチャを防止。

## コンテキストメニュー (`contextMenu.ts`)

### ページコンテキストメニュー
ページ上で右クリックすると「TabBurrow」メニューが表示される。

*   **TabBurrow** (親メニュー):
    *   **カスタムグループに保存**: サブメニューでカスタムグループを選択してタブを保存。「新規グループ...」から新しいグループを作成可能。
    *   **タブ管理から削除して閉じる**: 現在のページがタブ管理に保存されていれば削除し、ブラウザタブを閉じる。

### 拡張アイコンコンテキストメニュー
拡張アイコンを右クリックすると表示される。

*   **タブ管理画面を開く**: タブ管理画面を新しいタブで開く。
*   **固定タブも含めてすべてしまう**: 固定タブを含むすべてのタブを保存して閉じる。

### 動的メニュー更新
*   `updateCustomGroupMenus()`: カスタムグループの追加・削除時にサブメニューを再構築。
*   `updateContextMenuVisibility()`: タブ切替時に保存対象外URLではメニューを非表示に。

## リンクチェック (`linkChecker.ts`)

保存されたタブのリンク切れを検出する機能。

### 機能
*   **HEADリクエスト**: 各URLにHEADリクエストを送信してステータスコードを確認。
*   **同時実行制御**: グローバルおよびドメイン別の同時接続数を制限。
*   **ステータスコードルール**: 404、5xxなどのステータスコードに応じたアクション（alive/dead/warning/ignore）。
*   **一時停止・再開**: 長時間のチェック処理を一時停止・再開可能。
*   **進捗通知**: チェック進捗をUIにリアルタイム通知。

## 自動バックアップ (`backup.ts`)

データの定期バックアップ機能。

### 機能
*   **アラーム駆動**: 設定された間隔（1h/6h/12h/24h/カスタム）でバックアップを実行。
*   **世代管理**: 指定した世代数を超えた古いバックアップを自動削除。
*   **フルバックアップ**: タブデータ、スクリーンショット（Blob）、カスタムグループを含む完全なバックアップ。
*   **復元**: バックアップからの復元機能（設定画面から実行）。
